"""
bot.py â€” Telegram-Ð±Ð¾Ñ‚ Â«ÐšÐ¸Ð±ÐµÑ€ Ð“Ð¸Ð´Â»

Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:
- Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ (ReplyKeyboard): ðŸ§‘â€ðŸ’» ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚ / ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° / ðŸ“‹ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸
- ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚: ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ðº Ð˜Ð˜ (ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ñ ÑˆÐ°Ð³Ð°Ð¼Ð¸)
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°: ÑÑ‚Ñ€Ð¾Ð³Ð¾Ðµ Ð·Ð°ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ Ñ‚ÐµÐºÑÑ‚Ñƒ (Ð’ÐµÑ€Ð´Ð¸ÐºÑ‚/ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ/Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ/ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ)
- Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸: Ð¿Ð¾Ð»ÐµÐ·Ð½Ñ‹Ðµ Ð¿Ð°Ð¼ÑÑ‚ÐºÐ¸ (inline-ÐºÐ½Ð¾Ð¿ÐºÐ¸)
"""

import logging
from telegram import (
    Update,
    ReplyKeyboardMarkup,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
)
from telegram.ext import (
    Application,
    CommandHandler,
    ContextTypes,
    MessageHandler,
    CallbackQueryHandler,
    filters,
)
import dotenv

from model import chat_with_llm

# --- Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ---
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logging.getLogger("httpx").setLevel(logging.WARNING)
logger = logging.getLogger(__name__)

# --- Ñ‚Ð¾ÐºÐµÐ½ ---
try:
    env = dotenv.dotenv_values(".env")
    TELEGRAM_BOT_TOKEN = env["TELEGRAM_BOT_TOKEN"].strip()
except FileNotFoundError:
    raise FileNotFoundError("Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. ÐŸÐ¾Ð»Ð¾Ð¶Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.")
except KeyError as e:
    raise KeyError(f"ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ {str(e)} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð² .env")

# --- Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ ---
MAIN_KB = ReplyKeyboardMarkup(
    [
        ["ðŸ§‘â€ðŸ’» ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚", "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°"],
        ["ðŸ“‹ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸"],
    ],
    resize_keyboard=True,
)

# --- Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸: Ð»Ð°ÐºÐ¾Ð½Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ‡ÐµÐº-Ð»Ð¸ÑÑ‚Ñ‹ Ð´Ð»Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ---
INSTRUCTIONS = {
    "QUICK_START": (
        "ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚: 5 Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑˆÐ°Ð³Ð¾Ð²\n"
        "1) ÐŸÐ°Ñ€Ð¾Ð»Ð¸: Ð´Ð»Ð¸Ð½Ð½Ñ‹Ðµ Ð¸ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ, Ñ…Ñ€Ð°Ð½Ð¸ Ð² Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ðµ.\n"
        "2) 2FA: Ð²ÐºÐ»ÑŽÑ‡Ð¸ Ð² Ð¿Ð¾Ñ‡Ñ‚Ðµ, Ð±Ð°Ð½ÐºÐµ, ÑÐ¾Ñ†ÑÐµÑ‚ÑÑ… (Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ-Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€).\n"
        "3) ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ: ÐžÐ¡ Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ â€” ÑÑ€Ð°Ð·Ñƒ, Ð½Ðµ Ð¾Ñ‚ÐºÐ»Ð°Ð´Ñ‹Ð²Ð°Ð¹.\n"
        "4) Ð¡ÑÑ‹Ð»ÐºÐ¸: Ð½Ðµ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸ Ð¸Ð· Ð¿Ð¸ÑÐµÐ¼/Ñ‡Ð°Ñ‚Ð°; Ð²Ð²Ð¾Ð´Ð¸ Ð°Ð´Ñ€ÐµÑ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ.\n"
        "5) ÐšÐ¾Ð¿Ð¸Ð¸: ÑÐ´ÐµÐ»Ð°Ð¹ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¿Ð¸Ð¸ Ð²Ð°Ð¶Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð².\n"
        "Ð’Ð°Ð¶Ð½Ð¾: ÐºÐ¾Ð´Ñ‹/Ð¿Ð°Ñ€Ð¾Ð»Ð¸ Ð½Ð¸ÐºÐ¾Ð¼Ñƒ Ð½Ðµ ÑÐ¾Ð¾Ð±Ñ‰Ð°Ð¹ â€” Ð´Ð°Ð¶Ðµ Â«ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÑƒ Ð±Ð°Ð½ÐºÐ°Â»."
    ),
    "PHISHING": (
        "ðŸŽ£ Ð¤Ð¸ÑˆÐ¸Ð½Ð³: ÐºÐ°Ðº Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ñ‚ÑŒ\n"
        "ÐŸÑ€Ð¸Ð·Ð½Ð°ÐºÐ¸: ÑÑ€Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð¸ ÑƒÐ³Ñ€Ð¾Ð·Ñ‹; ÑÑ‚Ñ€Ð°Ð½Ð½Ñ‹Ðµ ÑÑÑ‹Ð»ÐºÐ¸/Ð´Ð¾Ð¼ÐµÐ½Ñ‹; Ð¿Ñ€Ð¾ÑÑŒÐ±Ð° ÐºÐ¾Ð´Ð¾Ð²/CVV/Ð´Ð¾ÐºÐ¾Ð²; Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ (.zip/.exe/.docm);\n"
        "ÑÑÑ‹Ð»ÐºÐ¸-ÑÐ¾ÐºÑ€Ð°Ñ‰Ð°Ñ‚ÐµÐ»Ð¸; Â«Ð²Ñ‹ Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð»Ð¸Â».\n"
        "Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ: Ð½Ðµ ÐºÐ»Ð¸ÐºÐ°Ð¹; Ð·Ð°Ð¹Ð´Ð¸ Ð½Ð° ÑÐ°Ð¹Ñ‚ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ; Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾; Ð¿Ñ€Ð¸ ÑÐ¾Ð¼Ð½ÐµÐ½Ð¸ÑÑ… Ð·Ð²Ð¾Ð½Ð¸ Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ Ñ ÐºÐ°Ñ€Ñ‚Ñ‹/ÑÐ°Ð¹Ñ‚Ð°."
    ),
    "BANK_CODES": (
        "ðŸ“ž ÐšÐ¾Ð´Ñ‹ Ð¸ Ð·Ð²Ð¾Ð½ÐºÐ¸ Â«Ð¸Ð· Ð±Ð°Ð½ÐºÐ°Â» â€” Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°\n"
        "â€¢ ÐšÐ¾Ð´ Ð¸Ð· SMS â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‚ÐµÐ±Ñ. ÐÐµ Ð´Ð¸ÐºÑ‚ÑƒÐ¹ Ð¸ Ð½Ðµ Ð¿ÐµÑ€ÐµÑÑ‹Ð»Ð°Ð¹.\n"
        "â€¢ Ð‘Ð°Ð½Ðº Ð½Ðµ Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ ÐºÐ¾Ð´, CVV, Â«Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ Ð½Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹ ÑÑ‡Ñ‘Ñ‚Â».\n"
        "â€¢ Ð—Ð²Ð¾Ð½Ð¾Ðº Â«Ð¸Ð· Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸Â»? ÐŸÐ¾Ð»Ð¾Ð¶Ð¸ Ñ‚Ñ€ÑƒÐ±ÐºÑƒ Ð¸ ÑÐ°Ð¼ Ð½Ð°Ð±ÐµÑ€Ð¸ Ð½Ð¾Ð¼ÐµÑ€ Ñ ÐºÐ°Ñ€Ñ‚Ñ‹/Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸.\n"
        "â€¢ Ð•ÑÐ»Ð¸ Ð²Ð²Ñ‘Ð» ÐºÐ¾Ð´ Ð½Ðµ Ñ‚Ð°Ð¼ â€” ÑÑ€Ð¾Ñ‡Ð½Ð¾ Ð¿Ð¾Ð·Ð²Ð¾Ð½Ð¸ Ð² Ð±Ð°Ð½Ðº, ÑÐ¼ÐµÐ½Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¸ Ð²ÐºÐ»ÑŽÑ‡Ð¸ 2FA."
    ),
    "2FA": (
        "ðŸ”‘ Ð”Ð²ÑƒÑ…Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ð½Ð°Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ (2FA)\n"
        "1) Ð’ÐºÐ»ÑŽÑ‡Ð¸ 2FA Ð² Ð¿Ð¾Ñ‡Ñ‚Ðµ, Ð±Ð°Ð½ÐºÐµ, ÑÐ¾Ñ†ÑÐµÑ‚ÑÑ…, Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ°Ñ….\n"
        "2) ÐŸÑ€ÐµÐ´Ð¿Ð¾Ñ‡Ð¸Ñ‚Ð°Ð¹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ-Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ (Google Authenticator/Authy/1Password).\n"
        "3) Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð´Ñ‹ Ð² Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¹ Ð¸Ð»Ð¸ Ð¾Ñ„Ð»Ð°Ð¹Ð½.\n"
        "4) ÐŸÑ€Ð¸ ÑÐ¼ÐµÐ½Ðµ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° Ð·Ð°Ñ€Ð°Ð½ÐµÐµ Ð¿ÐµÑ€ÐµÐ½ÐµÑÐ¸ 2FA."
    ),
    "PASSWORDS": (
        "ðŸ”’ ÐŸÐ°Ñ€Ð¾Ð»Ð¸ Ð¸ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€\n"
        "1) ÐžÐ´Ð¸Ð½ ÑÐµÑ€Ð²Ð¸Ñ â€” Ð¾Ð´Ð¸Ð½ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ (12â€“16+ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²).\n"
        "2) Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ (1Password, Bitwarden, KeePass).\n"
        "3) Ð’ÐºÐ»ÑŽÑ‡Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ ÑƒÑ‚ÐµÑ‡ÐµÐº/ÑÐ»Ð°Ð±Ñ‹Ñ… Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¹ Ð¸ Ð·Ð°Ð¼ÐµÐ½Ð¸ Ð¸Ñ….\n"
        "4) ÐŸÐ°Ñ€Ð¾Ð»Ð¸ Ð½Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐ¹ Ð² Ñ‡Ð°Ñ‚Ð°Ñ…/Ð¿Ð¾Ñ‡Ñ‚Ðµ. Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ â€” Ð·Ð°Ð¿Ð¾Ð¼Ð½Ð¸."
    ),
    "BREACH": (
        "âš ï¸ Ð•ÑÐ»Ð¸ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚ Ð²Ð·Ð»Ð¾Ð¼Ð°Ð½/Ð¿Ð¾Ð´ ÑƒÐ³Ñ€Ð¾Ð·Ð¾Ð¹\n"
        "1) Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ, Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ 2FA. Ð’Ñ‹Ð¹Ñ‚Ð¸ ÑÐ¾ Ð²ÑÐµÑ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð².\n"
        "2) ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ e-mail/Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¸ Ð´Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°.\n"
        "3) ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐµÑÑÐ¸Ð¸/ÐºÐ»ÑŽÑ‡Ð¸/Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ.\n"
        "4) ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ; Ð² Ð±Ð°Ð½ÐºÐµ â€” Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸/ÑÐ¿Ð¾Ñ€Ñ‹.\n"
        "5) ÐŸÑ€Ð¾ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾, Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐžÐ¡/Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€, Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð±ÑÐºÐ°Ð¿."
    ),
    "BACKUP": (
        "ðŸ’¾ Ð ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¿Ð¸Ð¸ (Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð¾ 3-2-1)\n"
        "â€¢ 3 ÐºÐ¾Ð¿Ð¸Ð¸; 2 Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»Ñ; 1 â€” Ð²Ð½Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° (Ð¾Ð±Ð»Ð°ÐºÐ¾/Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ Ð´Ð¸ÑÐº).\n"
        "Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚: Ð²ÐºÐ»ÑŽÑ‡Ð¸ Ð±ÑÐºÐ°Ð¿ Ð² Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ðµ Ð¸ Ð¾Ð±Ð»Ð°Ñ‡Ð½ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð².\n"
        "ÐŸÐ»Ð°Ð½: Ð°Ð²Ñ‚Ð¾-ÐºÐ¾Ð¿Ð¸Ñ Ñ€Ð°Ð· Ð² Ð´ÐµÐ½ÑŒ/Ð½ÐµÐ´ÐµÐ»ÑŽ; Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ€Ð°Ð· Ð² ÐºÐ²Ð°Ñ€Ñ‚Ð°Ð»."
    ),
}

def instruction_kb() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚", callback_data="INS::QUICK_START")],
        [InlineKeyboardButton("ðŸŽ£ Ð¤Ð¸ÑˆÐ¸Ð½Ð³", callback_data="INS::PHISHING"),
         InlineKeyboardButton("ðŸ“ž ÐšÐ¾Ð´Ñ‹/Ð·Ð²Ð¾Ð½ÐºÐ¸", callback_data="INS::BANK_CODES")],
        [InlineKeyboardButton("ðŸ”‘ 2FA", callback_data="INS::2FA"),
         InlineKeyboardButton("ðŸ”’ ÐŸÐ°Ñ€Ð¾Ð»Ð¸", callback_data="INS::PASSWORDS")],
        [InlineKeyboardButton("âš ï¸ ÐŸÑ€Ð¸ Ð²Ð·Ð»Ð¾Ð¼Ðµ", callback_data="INS::BREACH"),
         InlineKeyboardButton("ðŸ’¾ ÐšÐ¾Ð¿Ð¸Ð¸", callback_data="INS::BACKUP")],
    ])

# --- /start ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ + Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ. ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ñ€ÐµÐ¶Ð¸Ð¼ â€” Â«ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚Â».
    """
    welcome = (
        "**Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ!**\n"
        "Ð¯ â€” **ÐšÐ¸Ð±ÐµÑ€ Ð“Ð¸Ð´**, Ñ‚Ð²Ð¾Ð¹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð² Ð¼Ð¸Ñ€Ðµ ÐºÐ¸Ð±ÐµÑ€Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ ðŸ›¡ï¸\n\n"
        "Ð§Ñ‚Ð¾ Ð¼Ð¾Ð³Ñƒ:\n"
        "ðŸ§‘â€ðŸ’» ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° Ñ‚Ð²Ð¾Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹\n"
        "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð½Ð° Ð¼Ð¾ÑˆÐµÐ½Ð½Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾\n"
        "ðŸ“‹ Ð”Ð°Ñ‚ÑŒ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸, ÐºÐ°Ðº Ð·Ð°Ñ‰Ð¸Ñ‚Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ\n\n"
        "Ð’Ñ‹Ð±Ð¸Ñ€Ð°Ð¹ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð² Ð¼ÐµÐ½ÑŽ â€” Ð¸ Ð½Ð°Ñ‡Ð½Ñ‘Ð¼!"
    )
    context.user_data["mode"] = "consult"
    await update.message.reply_text(welcome, reply_markup=MAIN_KB, parse_mode="Markdown")

# --- Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº inline-ÐºÐ½Ð¾Ð¿Ð¾Ðº Â«Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸Â» ---
async def on_instruction_click(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    q = update.callback_query
    await q.answer()
    key = q.data.split("::", 1)[1]
    await q.edit_message_text(INSTRUCTIONS.get(key, "ÐÐµÑ‚ Ñ‚Ð°ÐºÐ¾Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸."))

# --- ÐµÐ´Ð¸Ð½Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð²ÑÐµÑ… Ñ‚ÐµÐºÑÑ‚Ð¾Ð² (ÐºÐ½Ð¾Ð¿ÐºÐ¸ + Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ) ---
async def on_text(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    text = (update.message.text or "").strip()

    # 1) ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð³Ð»Ð°Ð²Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ½ÑŽ
    if text == "ðŸ§‘â€ðŸ’» ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚":
        context.user_data["mode"] = "consult"
        await update.message.reply_text("Ð—Ð°Ð´Ð°Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ â€” Ð¾Ñ‚Ð²ÐµÑ‡Ñƒ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼Ð¸ ÑˆÐ°Ð³Ð°Ð¼Ð¸ ðŸ‘¨â€ðŸ’»")
        return

    if text == "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°":
        context.user_data["mode"] = "check"
        await update.message.reply_text("Ð’ÑÑ‚Ð°Ð²ÑŒ Ñ‚ÐµÐºÑÑ‚ Ð¿Ð¸ÑÑŒÐ¼Ð°/ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ â€” Ð´Ð°Ð¼ Ð°Ð½Ð°Ð»Ð¸Ð· Ð¿Ð¾ ÑÑ…ÐµÐ¼Ðµ ðŸ”")
        return

    if text == "ðŸ“‹ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸":
        await update.message.reply_text("Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑŽ ðŸ‘‡", reply_markup=instruction_kb())
        return

    # 2) Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ â€” ÑƒÑ…Ð¾Ð´Ð¸Ñ‚ Ð² LLM Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ð¾Ð¼
    mode = context.user_data.get("mode", "consult")  # consult | check
    history = context.chat_data.get("history", [])
    try:
        answer = chat_with_llm(text, history=history, mode=mode)
        context.chat_data["history"] = history
    except Exception:
        logger.exception("LLM error")
        answer = "Ð˜Ð·Ð²Ð¸Ð½Ð¸, ÑÐµÐ¹Ñ‡Ð°Ñ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ÑÑ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ð¾Ð·Ð¶Ðµ."

    await update.message.reply_text(answer)

def main() -> None:
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(on_instruction_click, pattern="^INS::"))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, on_text))
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
